# 项目长期记忆

## 项目概述
*更新于: 2026-02-06 16:40*

Mnemos 是一个为 AI Agent 提供持久记忆的工具。它能够通过 Git 历史自动生成短期记忆，并帮助管理结构化的长期记忆。

最近新增了 `mnemos init --only-skills` 选项，允许用户在不影响 `.memory` 目录下现有记忆文件的情况下，单独更新 `.agent/skills` 目录中的 Skill 模板文件。



### 未来路线图 (Roadmap / TODOs)
1. **智能化总结**：按 Conventional Commits 分组，增加文件变化热点分析。
2. **搜索功能 (`mnemos search`)**：支持跨记忆文件的全文检索。
3. **项目配置 (`.mnemos.toml`)**：支持自定义 VALID_SECTIONS、时间窗口和忽略文件。
4. **自动化压缩提醒**：当短期记忆过大时主动提示归档。
5. **诊断工具 (`mnemos doctor`)**：检查项目健康度及 Skill 配置。
6. **多语言支持**：支持生成英文版本的模板和 Skill。
7. **编辑器集成 (`mnemos edit`)**：快捷调用系统编辑器修改特定 Section。

*追加于: 2026-02-06 17:09*


### 搜索功能已上线 (`mnemos search`)
1. **跨文件检索**：支持同时搜索长期和短期记忆。
2. **上下文关联**：自动识别关键词所属的 Section（长期）或日期（短期）。
3. **过滤支持**：支持 `-t/--type` 限定范围，支持 `-d/--days` 限定短期记忆的时间窗口。

*追加于: 2026-02-06 17:18*


### 智能化维护：自动化压缩提醒
1. **自动检测**：在执行 `mnemos update` 后，系统会自动检测 `short_term.md` 的体积。
2. **可配置阈值**：支持在 `.mnemos.toml` 的 `[compression]` 模块中自定义 `max_lines` 和 `max_kb`。
3. **主动建议**：当短期记忆过大时，会向用户（及 Agent）发出警告，并建议执行 `mnemos compress` 进行归档，以维持高效的上下文处理。

*追加于: 2026-02-06 17:40*

## 架构决策
<!-- 重要的架构选择及其理由 -->

## 代码风格与约定
<!-- 团队/个人的编码偏好和规范 -->


### 最佳实践更新：AI Agent 记忆写入流程
为了彻底消除 Shell 对 Markdown（尤其是反引号）的解析风险，已在 Skill 模板中明确了 **AI Agent 推荐流程**：
1. **创建临时文件**：利用 `write_file` 创建纯净的 `.md` 内容。
2. **文件读取写入**：使用 `mnemos write -f <file>` 绕过命令行字符串传递。
3. **清理与同步**：删除临时文件并执行 `mnemos update`。

此流程已被记录为 Mnemos 系统的标准操作规范。

*追加于: 2026-02-06 16:52*

## 技术选型
<!-- 使用的关键技术栈及选择理由 -->

## 重要约束与注意事项
*追加于: 2026-02-06 16:45*

1. **安全写入**：在命令行更新记忆时，强烈建议使用 `stdin` 方式（如 `echo "content" | mnemos write -c -`），以避免反引号等 Markdown 符号被 Shell 误解析为命令执行。
2. **Skill 更新**：使用 `mnemos init --only-skills` 可以仅同步 Skill 定义，而不破坏已有的 `.memory` 记忆文件。
### 功能增强：安全写入与 Skill 维护
1. **-f/--file 参数**：支持从外部文件读取内容。通过 `mnemos write -f <file>` 写入，内容完全不经过 Shell 解析，解决了反引号等 Markdown 符号导致的执行风险。
2. **--only-skills 选项**：支持仅更新 `.agent/skills` 目录，保护 `.memory` 目录下的用户记忆不被覆盖。
3. **安全确认**：在替换长期记忆时增加了交互式确认。

*追加于: 2026-02-06 16:50*


### 健壮性改进：退出码与异常处理
1. **退出码修复**：修正了 CLI 在执行失败时（如无效 Section、文件缺失）仍返回 0 的问题。现在所有错误路径都会触发 `sys.exit(1)`。
2. **异常体系**：底层模块（memory, git, compress）改为抛出结构化异常（ValueError, FileNotFoundError），由 CLI 统一捕获并输出友好的错误提示。
3. **流程安全**：确保了 `&&` 链式命令在 `mnemos` 步骤失败时能够正确中断，防止后续清理或同步指令在错误状态下执行。

*追加于: 2026-02-06 16:56*


### 核心原则：Agent-First
1. **指令重于文档**：对于 AI Agent 驱动的项目，`SKILL.md` (或 `.agent/skills/`) 的更新优先级高于 `README.md`。必须确保 Agent 始终拥有最新的操作指引。
2. **同步机制**：在功能更新后，必须通过 `mnemos init --only-skills` 或手动更新，确保项目的 Skill 定义与代码实现保持一致。

### 最近技术更新 (2026-02-06)
1. **结构化短期记忆**：`mnemos update` 现在支持按 Conventional Commits 自动分组，并提供“核心变动区域”统计。
2. **安全写入增强**：全面支持 `-f/--file` 参数，作为 Agent 写入记忆的标准方式。
3. **健壮退出码**：所有错误路径均返回非零退出码，支持可靠的 `&&` 链式调用。

*追加于: 2026-02-06 17:15*


### 严正警告：操作红线
1. **严禁在本项目使用 `mnemos init -f`**：该命令会物理删除 `.memory` 目录及所有历史记录。在已建立记忆的项目中，如果需要更新模板，**必须**使用 `mnemos init --only-skills`。
2. **数据恢复意识**：如果发生误删，应立即检查版本控制系统（如 Git）进行恢复。

*追加于: 2026-02-06 17:31*


## 开发者日记
<!-- 记录开发过程中的心得和琐事 -->

